#!/bin/bash
# Ensures SSO for profile "dim", sets region/profile, wakes Cloud9 EC2, then SSHs via alias.

set -euo pipefail

PROFILE="dim"
REGION="us-east-2"
INSTANCE_ID="i-0731f39127dec7f02"
AWS="aws --profile $PROFILE --region $REGION"

echo "â˜ï¸ Connecting to AWS Cloud9 â˜ï¸ "
echo "ğŸ” Checking AWS SSO session for profile: $PROFILE..."
if ! $AWS sts get-caller-identity >/dev/null 2>&1; then
  echo "ğŸ‘‰ No valid SSO session. Logging in to $PROFILE..."
  aws sso login --profile "$PROFILE"
  $AWS sts get-caller-identity >/dev/null
fi
echo "âœ… SSO session is valid."

echo "ğŸ” Checking instance state for $INSTANCE_ID..."
STATE=$($AWS ec2 describe-instances \
  --instance-ids "$INSTANCE_ID" \
  --query "Reservations[0].Instances[0].State.Name" \
  --output text)

case "$STATE" in
  running)
    echo "âœ… Instance already running."
    ;;
  stopped)
    echo "âš¡ Instance is stopped â€” starting..."
    $AWS ec2 start-instances --instance-ids "$INSTANCE_ID" >/dev/null
    echo "â³ Waiting for instance to be running..."
    $AWS ec2 wait instance-running --instance-ids "$INSTANCE_ID"
    echo "âœ… Instance started."
    ;;
  pending)
    echo "â³ Instance is pending â€” waiting for running..."
    $AWS ec2 wait instance-running --instance-ids "$INSTANCE_ID"
    echo "âœ… Instance is running."
    ;;
  stopping)
    echo "â³ Instance is stopping â€” waiting to fully stop, then starting..."
    $AWS ec2 wait instance-stopped --instance-ids "$INSTANCE_ID"
    $AWS ec2 start-instances --instance-ids "$INSTANCE_ID" >/dev/null
    $AWS ec2 wait instance-running --instance-ids "$INSTANCE_ID"
    echo "âœ… Instance started."
    ;;
  *)
    echo "âŒ Instance is in state: $STATE (cannot auto-start)."
    exit 1
    ;;
esac

echo "ğŸ” Connecting via SSH..."
ssh cloud9
